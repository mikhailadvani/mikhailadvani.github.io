<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secret Management with Ansible</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="description" content="Personal bio of Mikhail Advani, Software Consultant">
    <meta name="keywords"
          content="Mikhail Advani, Devops, Ansible, Secret Management, git-crypt"/>
    <link rel="canonical" href="https://mikhailadvani.github.io/blog/secret-management-with-ansible.html">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Secret Management with Ansible">
    <meta property="og:description" content="Secret Management with Ansible by Mikhail Advani">
    <meta property="og:url" content="https://mikhailadvani.github.io/blog/secret-management-with-ansible.html">
    <meta property="og:image" content="https://mikhailadvani.github.io/images/secret-mgmt-with-ansible.png">
    <meta property="og:site_name" content="Mikhail Advani">
    <meta property="og:locale" content="en_US">
    <meta property="og:image:width" content="400">
    <meta property="og:image:height" content="210">
    <meta property="og:image:type" content="image/png">
    <script type="application/x-javascript"> addEventListener("load", function () {
        setTimeout(hideURLbar, 0);
    }, false);
    function hideURLbar() {
        window.scrollTo(0, 1);
    } </script>
    <link href="../css/bootstrap.css" rel="stylesheet" type="text/css" media="all"/>
    <link href="../css/blog_style.css" rel="stylesheet" type="text/css" media="all"/>
    <link type="text/css" rel="stylesheet" href="../css/cm-overlay.css"/>
    <link href="../css/font-awesome.css" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Gidugu" rel="stylesheet">
    <link href='//fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700,700italic,800,800italic'
          rel='stylesheet' type='text/css'>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-96989899-1', 'auto');
        ga('send', 'pageview');

    </script>
</head>
<body>
<div class="w3_navigation">
    <div class="container">
        <nav class="navbar navbar-default">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="/"><div class="logo navbar-brand"><span class="one"><i class="fa fa-github"></i></span>
                    <!--<h1><a class="navbar-brand" href="/"><span class="one">M</span>ikhail Advani</a></h1>-->
                </div></a>
            </div>
            <div class="collapse navbar-collapse nav-wil" id="bs-example-navbar-collapse-1">
                <nav class="cl-effect-1" id="cl-effect-1">
                    <ul class="nav navbar-nav">
                        <li class="active"><a class="scroll" href="/">Home</a></li>
                        <li><a href="#about" class="scroll hvr-bounce-to-bottom">About</a></li>
                        <li><a href="/#experience" class="scroll hvr-bounce-to-bottom">Experience</a></li>
                        <li><a href="/#education" class="scroll hvr-bounce-to-bottom">Education</a></li>
                        <li><a href="/#contact" class="scroll hvr-bounce-to-bottom">Contact</a></li>
                        <li><a href="#" >Blog</a></li>
                    </ul>
                </nav>
            </div>
        </nav>
    </div>
</div>
<div class="about" id="about">
    <div class="container">
        <h1 class="w3l_head">Secret Management with Ansible</h1>
        <h2 class="w3ls_head_para">By<br> Mikhail Advani</h2>
        <div class="w3l-grids-about">
            <div class="col-md-12 w3ls-agile-left">
                <div id="index" class="w3ls-agile-left-info">
                    <p align="center"><a href="#introduction">Introduction</a></p>
                    <p align="center"><a href="#plain-text-configurations">Plain Text Configurations</a></p>
                    <p align="center"><a href="#encryption-using-ansible-vault">Encryption Using Ansible Vault</a></p>
                    <p align="center"><a href="#committing-vault-password-to-git">Committing Vault Password to Git</a></p>
                    <p align="center"><a href="#encrypting-the-vault-password-file-using-git-crypt">Encrypting the Vault Password File using git-crypt</a></p>
                    <p align="center"><a href="#why-not-just-use git-crypt-without-vault">Why not just use git-crypt without vault</a></p>
                </div>
                <div id="introduction" class="w3ls-agile-left-info">
                    <h4><span>Introduction</span></h4>
                    <p align="justify">As you may know, Ansible stores configurations in yml format in key value pairs. Several times, these key value pairs may need to contain data that is sensitive and needs to be encrypted. Once encryption is achieved, the next typical challenge faced by most teams is to share the secret key to decrypt the secrets. <br><br>Over the next few steps, we will see how the plain text configurations encrypted yet shared efficiently with the rest of the team using ansible and git-crypt. The step by step implementation can also be found at this <a href="https://github.com/mikhailadvani/secret-management-with-ansible">Github repo</a>.</p>
                </div>
                <div id="plain-text-configurations" class="w3ls-agile-left-info">
                    <h4>Plain Text Configurations</h4>
                    <p>To start off, consider a file with key value pairs in plain text. The contents of the file would be:</p><br>
                    <div class="file_block"><br><p><span class="ansible_output">secret: </span>"$ecReT"</p><br></div><br>
                    <p>Execute a playbook which simple prints the value of the "secret". This output will be as follows: </p><br>
                    <div class="code_block"><br><p>$ ansible-playbook playbook.yml<br><p><span class="ansible_output">ok: [localhost] => { "msg": "$ecReT" }</span></p><br></div><br>
                    <span><a href="https://github.com/mikhailadvani/secret-management-with-ansible/tree/4c6e374dfc3d527beea84c33e1f5ac9503c68898" target="_blank">Repository status</a></span>

                </div>
                <div id="encryption-using-ansible-vault" class="w3ls-agile-left-info">
                    <h4>Encryption Using Ansible Vault</h4>
                    <p align="justify">Ansible provides a secret management solution called ansible-vault that encrypts yml files. The file is decrypted by ansible at run time by passing the vault-key. The command to encrypt the file is <span class="inline_code">ansible-vault encrypt &lt;file_name&gt;</span>. Enter the password when prompted. The password in this example is <span class="inline_code">abcd1234</span>. The file is now successfully encrypted. The contents of the file now appear as follows:</p><br>
                    <div class="file_block">
                        <br><p>$ANSIBLE_VAULT;1.1;AES256</p>
                        <p>33303332393835386162303861613934316632633639333535646438306163346161363431653461</p>
                        <p>6636323566663436396534626165396437393561366463610a636631623439323936303034393165</p>
                        <p>36626366343265623762333631663837366335323361653661666338616333313736343539643138</p>
                        <p>6465643331663535390a326539363735363736323162386461653431303331383632306330663261</p>
                        <p>33313432323566393330633931653766313661393261633035343737353762316537</p><br></div><br>
                    <p align="justify">The ansible-playbook command needs to be made aware to prompt for the vault password. This is carried out using the <span class="inline_code">--ask-vault-pass</span> option. The output of the playbook execution though, remains unchanged.</p><br>
                    <div class="code_block"><br><p>$ ansible-playbook playbook.yml --ask-vault-pass<br><p><span class="ansible_output">ok: [localhost] => { "msg": "$ecReT" }</span></p><br></div><br>
                    <span><a href="https://github.com/mikhailadvani/secret-management-with-ansible/tree/960367ce37faf5316adfc47fa0bbcda404c71bdd" target="_blank">Repository status</a></span>
                </div>
                <div id="committing-vault-password-to-git" class="w3ls-agile-left-info">
                    <h4>Committing Vault Password to Git</h4>
                    <p align="justify">Though the config files are encrypted, the password prompt hinders automation. The solution to this is using a password file rather than entering the password on prompt. The password file is a text file with the password in plain text. The password file can be passed as an option to the ansible-playbook command using the <span class="inline_code">--vault-password-file</span> option or configured in the <span class="inline_code">ansible.cfg</span> file. The real challenge though is sharing this password file. A simple but insecure way is to commit this file to git as-is. We will see in the next steps as to how the commit to git can also be secured. <span class="inline_code">ansible.cfg</span> below:</p><br>
                    <div class="file_block"><br><p>vault_password_file=vault.key</p><br></div><br>
                    <p align="justify">Since the password file is configured within <span class="inline_code">ansible.cfg</span> , there is no longer need to pass the <span class="inline_code">--ask-vault-pass</span> option. Output is still unchanged.</p><br>
                    <div class="code_block"><br><p>$ ansible-playbook playbook.yml<br><p><span class="ansible_output">ok: [localhost] => { "msg": "$ecReT" }</span></p><br></div><br>
                    <span><a href="https://github.com/mikhailadvani/secret-management-with-ansible/tree/1b0387f95627621641c8edab9618f3dd0c345646" target="_blank">Repository status</a></span>
                </div>
                <div id="encrypting-the-vault-password-file-using-git-crypt" class="w3ls-agile-left-info">
                    <h4>Encrypting the Vault Password File using git-crypt</h4>
                    <p align="justify">But this results in the key being left unencrypted. A solution to this is git-crypt. The vault password file can be encrypted using git-crypt. git-crypt supports asymmetric key encryption using GPG keys. Only aspect that needs to be considered is that git-crypt needs to be setup before adding any encrypted files to git. Hence, had to move the <span class="inline_code">vault.key</span> to <span class="inline_code">git_crypted_vault.key</span> in our case since the former already existed.</p><br>
                    <div class="code_block">
                        <br><p>$ git-crypt init<br></p>
                        <br><p>$ git-crypt add-gpg-user &lt;GPG_USER_ID&gt;</p><br>
                    </div><br>
                    <p align="justify">Create a file named <span class="inline_code">.gitattributes</span> to define which files should be encrypted.</p><br>
                    <div class="file_block"><br><p>*.key filter=git-crypt diff=git-crypt</p><br></div><br>
                    <p align="justify">The status of encrypted files can be seen as below:</p>
                    <div class="code_block"><br><p>$ git-crypt status git_crypted_vault.key<br><p><span class="ansible_output">&emsp;&emsp;encrypted: git_crypted_vault.key</span></p><br></div><br>
                    <span><a href="https://github.com/mikhailadvani/secret-management-with-ansible/tree/58de8551c6a15458192fd23c929f910a9e718ab2" target="_blank">Repository status</a></span>
                </div>
                <div id="why-not-just-use git-crypt-without-vault" class="w3ls-agile-left-info">
                    <h4>Why not just use git-crypt without vault</h4>
                    <p align="justify">Using git-crypt only might sound like a good idea but it has a couple of limitations. Firstly, it leaves the files on your local filesystem in plain text. Secondly, it is advantageous to use the secret management capability of the tool you are using directly. e.g. any configs you are using in ansible module calls, ansible by default masks the values in the execution log.</p>
                </div>
                <div class="w3ls-agile-left-info">
                <h4>Credits</h4>
                    <li><a href="https://www.ansible.com/">Ansible</a></li>
                    <li><a href="https://github.com/AGWA/git-crypt">git-crypt</a></li>
                </div>
                <div class="w3ls-agile-left-info">
                <h4>Feedback</h4>
                    <p>Would love to hear feedback at <a href="mailto:mikhailadvani1@gmail.com" rel="nofollow">mikhailadvani1@gmail.com</a></p>
                </div>
            </div>
            <div class="clearfix"> </div>
        </div>
    </div>
</div>
<div class="w3l_footer" id="contact">
    <div class="w3l_footer_pos">
        <p>© 2016 Classy Resume. All Rights Reserved | Design by <a href="https://w3layouts.com/">W3layouts</a></p>
    </div>
</div>
</body>
</html>